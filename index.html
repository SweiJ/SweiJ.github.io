<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>SweiJ的博客 | 望开开心心每一天！</title>

  
  <meta name="author" content="Swei">
  

  
  <meta name="description" content="日常随笔">
  

  
  <meta name="keywords" content="随笔">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  

  <meta property="og:site_name" content="SweiJ的博客"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="SweiJ的博客" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">SweiJ的博客</a>
    </h1>
    <p class="site-description">望开开心心每一天！</p>
  </div>
  <nav class="site-navigation">
    <ul>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    
  <article>

  
    
    <h3 class="article-title"><a href="/2023/09/21/http-协议基本格式/"><span>http 协议基本格式</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2023/09/21/http-协议基本格式/" rel="bookmark">
        <time class="entry-date published" datetime="2023-09-21T01:41:41.000Z">
          2023-09-21
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="一-http是什么"><a href="#一-http是什么" class="headerlink" title="一. http是什么"></a>一. http是什么</h1><p>http(超文本传输协议)是应用层协议 </p>
<p>http大部分基于传输层TCP协议实现, 其中http1.0、http1.1、http2.0均为TCP, http3基于UDP实现</p>
<p>当我们使用浏览器访问一个网页时, 首先用户向服务器发送一个http请求, 然后服务器收到这个请求会返回一个http响应数据</p>
<p><img src="https://img-blog.csdnimg.cn/9b2ca8cc3bbf4b40b603cbe8779f0ab3.png" alt="在这里插入图片描述">事实上, 当我们访问一个网站时, 可能涉及不止一次的http请求&#x2F;响应的交互过程</p>
<h1 id="二-抓包工具"><a href="#二-抓包工具" class="headerlink" title="二. 抓包工具"></a>二. 抓包工具</h1><p>下面我们使用Fiddler对http请求&#x2F;响应进行抓取</p>
<p><a  href ="https://www.telerik.com/fiddler/">Fiddler下载 </a></p>
<p>打开Fiddler我们可以看到很多抓取到的http请求&#x2F;响应</p>
<p><img src="https://img-blog.csdnimg.cn/40b6a9defaf44561a5d09edb8b7ce50d.png" alt="在这里插入图片描述"></p>
<h2 id="1-抓包工具原理"><a href="#1-抓包工具原理" class="headerlink" title="1. 抓包工具原理"></a>1. 抓包工具原理</h2><p>Fiddler相当于一个”代理”</p>
<p>当浏览器访问一个网址时, 首先会把http请求先发给Fiddler, Fiddler再把请求转发给服务器, 当服务器返回数据时, Fiddler拿到返回数据, 再把数据交给浏览器</p>
<p><img src="https://img-blog.csdnimg.cn/c83e9f6943ff4d418310bc41f99eec75.png" alt="在这里插入图片描述"></p>
<h3 id="a-抓包结果"><a href="#a-抓包结果" class="headerlink" title="a) 抓包结果**"></a>a) 抓包结果**</h3><p><strong>http请求</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GET https://www.csdn.net/community/toolbar-api/v1/get-user-info HTTP/1.1</span><br><span class="line">Host: www.csdn.net</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:100.0) Gecko/20100101 Firefox/100.0</span><br><span class="line">Accept: application/json, text/javascript, */*; q=0.01</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate, br</span><br><span class="line">Referer: https://blog.csdn.net/qq_54219272/article/details/123853319</span><br><span class="line">Content-Type: application/x-www-form-urlencoded; charset=utf-8</span><br><span class="line">Origin: https://blog.csdn.net</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Cookie: uuid_tt_dd=10_18653979800-1652881261106-378096; </span><br><span class="line">Sec-Fetch-Dest: empty</span><br><span class="line">Sec-Fetch-Mode: cors</span><br><span class="line">Sec-Fetch-Site: same-site</span><br></pre></td></tr></table></figure>
<p><strong>首行</strong>: 方法 + url + 版本<br><strong>Header</strong>: 请求的属性, 冒号分隔的键值对, 每组属性之间使用\n分隔, 遇到空行表示Header部分结束<br><strong>Body</strong>: 空行后面的内容都是Body, Body允许为空字符串, 如果Body存在. 则在Header中会有一个Content-Length属性来标识Body的长度</p>
<p><strong>http响应</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: openresty</span><br><span class="line">Date: Thu, 19 May 2022 10:27:12 GMT</span><br><span class="line">Content-Type: application/json;charset=utf-8</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Keep-Alive: <span class="built_in">timeout</span>=20</span><br><span class="line">Vary: Origin</span><br><span class="line">Vary: Access-Control-Request-Method</span><br><span class="line">Vary: Access-Control-Request-Headers</span><br><span class="line">Access-Control-Allow-Origin: https://blog.csdn.net</span><br><span class="line">Access-Control-Allow-Credentials: <span class="literal">true</span></span><br><span class="line">Strict-Transport-Security: max-age=31536000</span><br><span class="line"></span><br><span class="line">b4</span><br><span class="line">&#123;<span class="string">&quot;code&quot;</span>:200,<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;success&quot;</span>,<span class="string">&quot;data&quot;</span>:&#123;<span class="string">&quot;nickName&quot;</span>:<span class="string">&quot;IT自习小空间&quot;</span>,<span class="string">&quot;avatar&quot;</span>:<span class="string">&quot;https://profile.csdnimg.cn/f/7/2/3_jiangnb520&quot;</span>,<span class="string">&quot;fansCount&quot;</span>:79,<span class="string">&quot;likeCount&quot;</span>:31,<span class="string">&quot;vip&quot;</span>:2,<span class="string">&quot;followCount&quot;</span>:35&#125;&#125;</span><br><span class="line">0</span><br></pre></td></tr></table></figure>
<p><strong>首行</strong>: 版本号 + 状态码 + 状态码解释<br><strong>Header</strong>: 请求的属性, 冒号分隔的键值对, 每组属性之间使用\n分隔, 遇到空行表示Header部分结束<br><strong>Body</strong>: 空行后面的内容都是Body, Body允许为空字符串, 如果Body存在, 则在Header中会有一个Content-Length属性来标识Body的长度, 如果服务器返回一个html页面, 那么html页面内容就是在body中</p>
<h1 id="三-http请求"><a href="#三-http请求" class="headerlink" title="三. http请求"></a>三. http请求</h1><h2 id="1-认识URL"><a href="#1-认识URL" class="headerlink" title="1. 认识URL"></a>1. 认识URL</h2><p>URL(Uniform Resource Location)统一资源定位符<br><img src="https://img-blog.csdnimg.cn/a9ca6dac61fa481688c86475f70ed279.png" alt="在这里插入图片描述">query string: 这是一个以键值对结构形式存在, 主要是为了定制传输我们需要的信息给服务器</p>
<p>URL中可省略的部分</p>
<ul>
<li>协议名: 省略后默认为http:&#x2F;&#x2F;</li>
<li>ip地址&#x2F;域名: 在HTML中可以省略, 省略后表示服务器的ip域名与当前所属的ip&#x2F;域名一致</li>
<li>端口号: http端口号为80, https端口号为433</li>
<li>文件路径: 可以省略, 省略后相当于&#x2F;, 有些服务器会在发现&#x2F;路径的时候自动访问&#x2F;index,html</li>
<li>查询字符串: 可以省略</li>
<li>片段标识: 可以省略</li>
</ul>
<p><strong>URL encode</strong></p>
<p>一个中文字符由 UTF-8 或者 GBK 这样的编码方式构成, 虽然在 URL 中没有特殊含义, 但是仍然需要进行转义. 否则浏览器可能把 UTF-8&#x2F;GBK 编码中的某个字节当做 URL 中的特殊符号.<br>转义的规则如下: 将需要转码的字符转为16进制，然后从右到左，取4位(不足4位直接处理)，每2位做一位，前面加上%，编码成%XY格式, 如下图<br><img src="https://img-blog.csdnimg.cn/01854edee3d743d99b63b1131c46ba63.png" alt="在这里插入图片描述"></p>
<h2 id="2-认识方法-method"><a href="#2-认识方法-method" class="headerlink" title="2. 认识方法(method)"></a>2. 认识方法(method)</h2><h3 id="a-GET-POST方法"><a href="#a-GET-POST方法" class="headerlink" title="a) GET&#x2F;POST方法"></a>a) GET&#x2F;POST方法</h3><p>GET和POST方法是HTTP最常见的方法</p>
<p> <strong>GET</strong></p>
<p>GET常用于获取服务器上的某个资源, 浏览器直接输入URL发送的是一个GET请求, HTML中的link、img、script等标签, 也会触发GET请求, JavaScript中的ajax也能构造GET请求</p>
<p>使用Fiddler抓取一个GET请求</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET https://www.sogou.com/ HTTP/1.1</span><br><span class="line">Host: www.sogou.com</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">sec-ch-ua: <span class="string">&quot; Not;A Brand&quot;</span>;v=<span class="string">&quot;99&quot;</span>, <span class="string">&quot;Google Chrome&quot;</span>;v=<span class="string">&quot;91&quot;</span>, <span class="string">&quot;Chromium&quot;</span>;v=<span class="string">&quot;91&quot;</span></span><br><span class="line">sec-ch-ua-mobile: ?0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML,</span><br><span class="line">like Gecko) Chrome/91.0.4472.77 Safari/537.36</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可以看到GET请求的首行第一部分为GET, URL的query, string可以为空, 也可以不为空, header部分有若干个键值对结构, body部分为空. </p>
<p><strong>POST</strong></p>
<p>POST请求多用于提交数据给服务器(例如登陆账号)</p>
<p>可以通过form表单或者ajax构造POST请求</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">POST https://v.bitedu.vip/tms/login HTTP/1.1</span><br><span class="line">Host: v.bitedu.vip</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Content-Length: 105</span><br><span class="line">sec-ch-ua: <span class="string">&quot; Not;A Brand&quot;</span>;v=<span class="string">&quot;99&quot;</span>, <span class="string">&quot;Google Chrome&quot;</span>;v=<span class="string">&quot;91&quot;</span>, <span class="string">&quot;Chromium&quot;</span>;v=<span class="string">&quot;91&quot;</span></span><br><span class="line">sec-ch-ua-mobile: ?0</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML,</span><br><span class="line">like Gecko) Chrome/91.0.4472.77 Safari/537.36</span><br><span class="line">Content-Type: application/json;charset=UTF-8</span><br><span class="line">Access-Control-Allow-Origin: *</span><br><span class="line">Accept: application/json, text/plain, */*</span><br><span class="line">Access-Control-Allow-Headers: Content-Type, Content-Length, Authorization,</span><br><span class="line">Accept, X-Requested-With , yourHeaderFeild</span><br><span class="line">Origin: https://v.bitedu.vip</span><br><span class="line">Sec-Fetch-Site: same-origin</span><br><span class="line">Sec-Fetch-Mode: cors</span><br><span class="line">Sec-Fetch-Dest: empty</span><br><span class="line">Referer: https://v.bitedu.vip/login</span><br><span class="line">Accept-Encoding: gzip, deflate, br</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line">Cookie: username=123456789; rememberMe=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">&#123;<span class="string">&quot;username&quot;</span>:<span class="string">&quot;123456789&quot;</span>,<span class="string">&quot;password&quot;</span>:<span class="string">&quot;xxxx&quot;</span>,<span class="string">&quot;code&quot;</span>:<span class="string">&quot;jw7l&quot;</span>,<span class="string">&quot;uuid&quot;</span>:<span class="string">&quot;d110a05ccde64b16</span></span><br><span class="line"><span class="string">a861fa2bddfdcd15&quot;</span>&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>首行第一部分为POST, URL的query string一般为空(也可以不为空), header部分有若干个键值对结构, body一般不为空, body内的数据格式通过header中的Content-Type指定, body的长度由header中的Content-Length指定</p>
<h3 id="b-其他方法"><a href="#b-其他方法" class="headerlink" title="b) 其他方法"></a>b) 其他方法</h3><ul>
<li><p>PUT和POST类似, 知识具有冥等特性, 一般用于更新</p>
</li>
<li><p>DELETE删除服务器指定资源</p>
</li>
<li><p>OPTIONS返回服务器所支持的请求方法</p>
</li>
<li><p>HEAD类似于GET, 只不过响应体不返回, 只返回响应头</p>
</li>
<li><p>TRACE回显服务器端收到的请求, 测试的时候会用到这个</p>
</li>
<li><p>CONNECT预留, 暂无使用</p>
</li>
</ul>
<h2 id="3-认识部分请求”报头”字段"><a href="#3-认识部分请求”报头”字段" class="headerlink" title="3. 认识部分请求”报头”字段"></a>3. 认识部分请求”报头”字段</h2><p>Content-Type</p>
<p>表示请求的body中的数据格式</p>
<ul>
<li><p>application&#x2F;x-www-from-urlencoded: form表单提交的数据格式, body格式形如: <code>title=test&amp;content=hello</code></p>
</li>
<li><p>multipart&#x2F;form-data: 通常用于提交图片&#x2F;文件</p>
</li>
<li><p>application&#x2F;json: 数据json格式, body格式形如</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;username&quot;</span>:<span class="string">&quot;123456789&quot;</span>,<span class="string">&quot;password&quot;</span>:<span class="string">&quot;xxxx&quot;</span>,<span class="string">&quot;code&quot;</span>:<span class="string">&quot;jw7l&quot;</span>,<span class="string">&quot;uuid&quot;</span>:<span class="string">&quot;d110a05ccde64b16a861fa2bddfdcd15&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>Cookie</p>
<p>Cookie中存储了一个字符串, 这个数据可能是客户端(网页)自行通过js写入的, 也坑你来自于服务器, 主要用来实现”身份标识”功能</p>
<h1 id="四-http响应"><a href="#四-http响应" class="headerlink" title="四. http响应"></a>四. http响应</h1><h2 id="1-认识状态码"><a href="#1-认识状态码" class="headerlink" title="1. 认识状态码"></a>1. 认识状态码</h2><p><strong>200 OK</strong>: 表示访问成功</p>
<p><strong>404 Not Found</strong>: 表示这个URL标识的资源不存在</p>
<p><strong>403 Forbidden</strong>: 表示访问被拒绝, 有的页面需要用户具有一定的权限才能访问</p>
<p><strong>405 Menthod Not Allowed</strong>: 表示对方的服务器不支持所有的方法或者不允许用户使用一些其他的方法</p>
<p><strong>500 Internal Server Error</strong>: 服务器内部错误, 一般都是服务器代码在执行过程中遇到了一些异常</p>
<p><strong>504 Gateway Timeout</strong>: 服务器负载比较大时, 服务器处理单条请求的时候消耗的时间就会很长, 会导致出现超时情况</p>
<p><strong>302 Move temporarily</strong>: 临时重定向, 一般用于实现登陆成功自动跳转到主页</p>
<p><strong>301 Moved Permanently</strong>: 永久重定向</p>
<h2 id="2-认识响应”正文”"><a href="#2-认识响应”正文”" class="headerlink" title="2. 认识响应”正文”"></a>2. 认识响应”正文”</h2><p>text&#x2F;html</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">Server: nginx/1.17.3</span><br><span class="line">Date: Thu, 10 Jun 2021 07:25:09 GMT</span><br><span class="line">Content-Type: text/html; charset=utf-8</span><br><span class="line">Last-Modified: Thu, 13 May 2021 09:01:26 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: W/<span class="string">&quot;609ceae6-3206&quot;</span></span><br><span class="line">Content-Length: 12806</span><br><span class="line">&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;<span class="built_in">head</span>&gt;&lt;meta charset=utf-8&gt;&lt;meta http-equiv=X-UA-Compatible</span><br><span class="line">content=<span class="string">&quot;IE=edge,chrome=1&quot;</span>&gt;&lt;meta name=renderer content=webkit&gt;&lt;meta</span><br><span class="line">name=viewport content=<span class="string">&quot;width=device-width,initial-scale=1,minimumscale=1,maximum-scale=1,user-scalable=no&quot;</span>&gt;&lt;<span class="built_in">link</span> rel=icon href=/favicon.ico&gt;</span><br><span class="line">&lt;title <span class="built_in">id</span>=bodyTitle&gt;比特教务管理系统&lt;/title&gt;&lt;<span class="built_in">link</span></span><br><span class="line">href=https://cdn.bootcss.com/jquerydatetimepicker/2.5.20/jquery.datetimepicker.css rel=stylesheet&gt;&lt;script</span><br><span class="line">src=https://cdn.bootcss.com/highlight.js/9.1.0/highlight.min.js&gt;&lt;/script&gt;&lt;script</span><br><span class="line">src=https://cdn.bootcss.com/highlightjs-line-numbers.js/2.5.0/highlightjs-linenumbers.min.js&gt;&lt;/script&gt;&lt;style&gt;html,</span><br><span class="line">	body,</span><br><span class="line">	<span class="comment">#app &#123;</span></span><br><span class="line">		height: 100%;</span><br><span class="line">		margin: 0px;</span><br><span class="line">		padding: 0px;</span><br><span class="line">	&#125;</span><br><span class="line">	.chromeframe &#123;</span><br><span class="line">		margin: 0.2em 0;</span><br><span class="line">		background: <span class="comment">#ccc;</span></span><br><span class="line">		color: <span class="comment">#000;</span></span><br><span class="line">		padding: 0.2em 0;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">#loader-wrapper &#123;</span></span><br><span class="line">		position: fixed;</span><br><span class="line">		top: 0;</span><br><span class="line">		left: 0;</span><br><span class="line">		width: 100%;</span><br><span class="line">		height: 100%;</span><br><span class="line">		z-index: 999999;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>text&#x2F;css</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.17.3</span><br><span class="line">Date: Thu, 10 Jun 2021 07:25:09 GMT</span><br><span class="line">Content-Type: text/css</span><br><span class="line">Last-Modified: Thu, 13 May 2021 09:01:26 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: W/<span class="string">&quot;609ceae6-3cfbe&quot;</span></span><br><span class="line">Content-Length: 249790</span><br><span class="line">@font-face&#123;font-family:element-icons;src:url(../../static/fonts/elementicons.535877f5.woff) format(<span class="string">&quot;woff&quot;</span>),url(../../static/fonts/elementicons.732389de.ttf) format(<span class="string">&quot;truetype&quot;</span>);font-weight:400;font-style:normal&#125;</span><br><span class="line">[class*=<span class="string">&quot; el-icon-&quot;</span>]</span><br></pre></td></tr></table></figure>
<p>application&#x2F;javascript</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.17.3</span><br><span class="line">Date: Thu, 10 Jun 2021 07:25:09 GMT</span><br><span class="line">Content-Type: application/javascript; charset=utf-8</span><br><span class="line">Last-Modified: Thu, 13 May 2021 09:01:26 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: W/<span class="string">&quot;609ceae6-427d4&quot;</span></span><br><span class="line">Content-Length: 272340</span><br><span class="line">(window[<span class="string">&quot;webpackJsonp&quot;</span>]=window[<span class="string">&quot;webpackJsonp&quot;</span>]||[]).push([[<span class="string">&quot;app&quot;</span>],</span><br><span class="line">&#123;0:<span class="keyword">function</span>(t,e,n)&#123;t.exports=n(<span class="string">&quot;56d7&quot;</span>)&#125;,<span class="string">&quot;00b3&quot;</span>:<span class="keyword">function</span>(t,e,n)&#123;&#125;,<span class="string">&quot;</span></span><br></pre></td></tr></table></figure>

<p>application&#x2F;json</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200</span><br><span class="line">Server: nginx/1.17.3</span><br><span class="line">Date: Thu, 10 Jun 2021 07:25:10 GMT</span><br><span class="line">Content-Type: application/json;charset=UTF-8</span><br><span class="line">Connection: keep-alive</span><br><span class="line">X-Content-Type-Options: nosniff</span><br><span class="line">X-XSS-Protection: 1; mode=block</span><br><span class="line">Cache-Control: no-cache, no-store, max-age=0, must-revalidate</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Expires: 0</span><br><span class="line">vary: accept-encoding</span><br><span class="line">Content-Length: 12268</span><br><span class="line"></span><br><span class="line">&#123;<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;操作成功&quot;</span>,<span class="string">&quot;code&quot;</span>:200,<span class="string">&quot;permissions&quot;</span>:[] &#125;</span><br></pre></td></tr></table></figure>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2023/09/21/Docker常用命令及常用服务的安装/"><span>Docker常用命令及常用服务的安装</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2023/09/21/Docker常用命令及常用服务的安装/" rel="bookmark">
        <time class="entry-date published" datetime="2023-09-21T01:31:36.000Z">
          2023-09-21
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="一-什么是Docker"><a href="#一-什么是Docker" class="headerlink" title="一. 什么是Docker?"></a>一. 什么是Docker?</h1><p>Docker 是一个开源的应用容器引擎，让开发者可以打包他们的应用以及依赖包到一个可移植的镜像中，然后发布到任何流行的 Linux或Windows操作系统的机器上，也可以实现虚拟化。容器是完全使用沙箱机制，相互之间不会有任何接口。</p>
<h1 id="二-Docker安装"><a href="#二-Docker安装" class="headerlink" title="二. Docker安装"></a>二. Docker安装</h1><p>下面是一个通用的docker安装命令, 使用aliyun镜像下载</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ curl -fsSL get.docker.com -o get-docker.sh</span><br><span class="line">$ sudo sh get-docker.sh --mirror Aliyun</span><br></pre></td></tr></table></figure>
<h1 id="三-Docker常用命令"><a href="#三-Docker常用命令" class="headerlink" title="三. Docker常用命令"></a>三. Docker常用命令</h1><p><strong>(1) 配置阿里云加速–拉取镜像时用国内的更快</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ sudo <span class="built_in">mkdir</span> -p /etc/docker</span><br><span class="line">$ sudo <span class="built_in">tee</span> /etc/docker/daemon.json &lt;&lt;-<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://lz2nib3q.mirror.aliyuncs.com&quot;</span>] // 自己的镜像加速链接</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">$ sudo systemctl daemon-reload</span><br><span class="line">$ sudo systemctl restart docker</span><br></pre></td></tr></table></figure>

<p><strong>(2) 启动docker</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo systemctl <span class="built_in">enable</span> docker</span><br><span class="line">$ sudo systemctl start docker</span><br></pre></td></tr></table></figure>
<p><strong>(3) 镜像相关命令</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker images  // 查看docker镜像</span><br><span class="line">docker pull tomcat // 拉取镜像 不加版本号则拉取最新版本</span><br><span class="line">docker image <span class="built_in">rm</span> 镜像名/image <span class="built_in">id</span>  // 删除没有运行过的容器</span><br><span class="line">docker image <span class="built_in">rm</span> -f 镜像名/image <span class="built_in">id</span>   // 强制删除容器</span><br><span class="line">docker image -q  // 查看所有容器的<span class="built_in">id</span></span><br><span class="line">docker image tomcat -q  // 查看所有tomcat容器的<span class="built_in">id</span></span><br><span class="line">docker ps -qa  // 查询所有容器的<span class="built_in">id</span></span><br></pre></td></tr></table></figure>

<p><strong>(4) 容器相关命令</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">// 运行一个容器 例如:docker run tomcat9.0</span><br><span class="line">docker run 镜像名|镜像<span class="built_in">id</span></span><br><span class="line">docker stop 镜像<span class="built_in">id</span>|容器名称     // 停止容器</span><br><span class="line">docker start 镜像<span class="built_in">id</span>|容器名称    // 开启容器</span><br><span class="line">docker restart 容器<span class="built_in">id</span>|容器名称  // 重启容器</span><br><span class="line">docker pause 容器<span class="built_in">id</span>|容器名称    // 暂停容器</span><br><span class="line">docker unpause 容器<span class="built_in">id</span>|容器名称  // 恢复容器</span><br><span class="line">docker <span class="built_in">kill</span> 镜像<span class="built_in">id</span>|容器名称 // 杀死容器</span><br><span class="line">docker <span class="built_in">rm</span> 容器<span class="built_in">id</span>|容器名称     // 删除已经停止的容器</span><br><span class="line">docker <span class="built_in">rm</span> -f 容器<span class="built_in">id</span>|容器名称  // 强制删除容器</span><br><span class="line">docker <span class="built_in">rm</span> -f $(docker ps -qa) // 删除所有容器</span><br><span class="line">// 查看运行的容器</span><br><span class="line">docker ps</span><br><span class="line">// 查看所有的容器</span><br><span class="line">docker ps -a</span><br><span class="line">// docker进入容器终端, 其中数字为容器<span class="built_in">id</span></span><br><span class="line">docker <span class="built_in">exec</span> -it 容器<span class="built_in">id</span> bash</span><br><span class="line">// 退出容器</span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">// 查看容器内运行进程</span><br><span class="line">docker top 容器<span class="built_in">id</span>|容器名称</span><br><span class="line">// 查看容器内细节指令</span><br><span class="line">docker inspect 容器<span class="built_in">id</span>|容器名称</span><br></pre></td></tr></table></figure>

<p><strong>(5) 容器日志相关命令</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// OPTIONS为可添加的参数</span><br><span class="line">docker logs [OPTIONS] 容器<span class="built_in">id</span>或容器名</span><br><span class="line">// 实时监控容器内的服务日志</span><br><span class="line">docker logs -f 容器<span class="built_in">id</span>或容器名</span><br></pre></td></tr></table></figure>

<p><strong>(6) 容器和宿主机之间的文件拷贝</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 将容器中指定文件和目录拷贝到宿主机</span><br><span class="line">docker <span class="built_in">cp</span> 容器<span class="built_in">id</span>:容器中文件或目录  主机目录</span><br><span class="line">// 将宿主机文件和目录拷贝到容器中</span><br><span class="line">docker <span class="built_in">cp</span> 主机目录  容器<span class="built_in">id</span>:容器中文件或目录 </span><br></pre></td></tr></table></figure>

<p><strong>(7) 容器数据卷机制</strong></p>
<p>数据卷 Data Volume<br>用来实现容器中数据和宿主机中数据进行映射(同步)</p>
<p>第一次启动容器时需要指定</p>
<ul>
<li>使用绝对路径设置数据卷</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run -v 宿主机绝对路径:容器内路:ro 镜像名</span><br><span class="line">docker run -d --name tmocat01 -v /root/apps:/usr/local/tomcat/webapps:ro tomcate:9.0</span><br></pre></td></tr></table></figure>

<p>ro: read only 如果在设置数据卷时指定ro, 代表容器内路径是只读的</p>
<ul>
<li>使用别名方式设置数据卷</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run -v  a:容器路径</span><br><span class="line">docker run -v a:/usr/local/tomcat/webapps tomcat:9.0</span><br></pre></td></tr></table></figure>

<p>a是docker数据卷中的别名 当这个别名在docker中存在,则直接使用, 否则自动创建, 创建的路径默认在: &#x2F;var&#x2F;lib&#x2F;docker&#x2F;volumes<br>使用别名方式保留容器路径原始内容, 前提别名对应路径不能存在内容</p>
<p><strong>(8) 将容器打包成一个镜像</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker commit -m <span class="string">&quot;webapps&quot;</span> -a <span class="string">&quot;swei&quot;</span>  容器<span class="built_in">id</span>|容器名称 镜像名:版本</span><br><span class="line">-m 信息</span><br><span class="line">-a 作者信息</span><br><span class="line">docker commit -m <span class="string">&quot;webapps&quot;</span> -a <span class="string">&quot;swei&quot;</span> e77 tomcatdemo:9.0</span><br></pre></td></tr></table></figure>

<p><strong>(9) 备份镜像和恢复</strong></p>
<ul>
<li>备份镜像</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker save 镜像名: Tag -o (镜像名-tag).tar</span><br><span class="line">docker save tomcat:9.0 -o /root/tomcat-9.0.tar</span><br></pre></td></tr></table></figure>

<ul>
<li>恢复镜像</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker load -i /root/tomcat-9.0.tar</span><br></pre></td></tr></table></figure>

<h1 id="四-Docker常用服务"><a href="#四-Docker常用服务" class="headerlink" title="四. Docker常用服务"></a>四. Docker常用服务</h1><h2 id="1-mysql服务"><a href="#1-mysql服务" class="headerlink" title="1. mysql服务"></a>1. mysql服务</h2><p>(1) 拉取mysql</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull mysql:5.6</span><br></pre></td></tr></table></figure>

<p>(2) 运行mysql, 首次安装mysql需要密码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -e MYSQL_ROOT_PASSWORD=root -p 3306:3306 --name mysql01 --restart=always mysql5.6</span><br><span class="line"></span><br><span class="line">-e MYSQL_ROOT_PASSWORD=root  // 指定环境密码</span><br><span class="line">--resart=always // 总是运行</span><br></pre></td></tr></table></figure>

<p>(3) 使用数据卷持久化数据到宿主机</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -e MYSQL_ROOT_PASSWORD=root -p 3306:3306 --name mysql01 -v /root/data:/var/lib/mysql --restart=always mysql5.6</span><br></pre></td></tr></table></figure>

<p>(4) 数据库备份, 利用mysql官方命令mysqldump</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// 备份数据库所有的表信息</span><br><span class="line">docker <span class="built_in">exec</span> mysql容器<span class="built_in">id</span> sh -c <span class="string">&#x27;exec mysqldump --all-databases -uroot -p&quot;$MYSQL_ROOT_PASSWORD&quot;&#x27;</span> &gt; /root/all-databases.sql</span><br><span class="line"></span><br><span class="line">// 备份指定库的表</span><br><span class="line">docker <span class="built_in">exec</span> mysql容器<span class="built_in">id</span> sh -c <span class="string">&#x27;exec mysqldump --databases ems -uroot -p&quot;$MYSQL_ROOT_PASSWORD&quot;&#x27;</span> &gt; /root/ems.sql</span><br><span class="line"></span><br><span class="line">// 备份指定库中的结构</span><br><span class="line">docker <span class="built_in">exec</span> mysql容器<span class="built_in">id</span> sh -c <span class="string">&#x27;exec mysqldump --no-data --databases ems -uroot -p&quot;$MYSQL_ROOT_PASSWORD&quot;&#x27;</span> &gt; /root/ems.sql</span><br></pre></td></tr></table></figure>

<p>使用navicat可以直接导出sql表数据</p>
<h2 id="2-redis服务"><a href="#2-redis服务" class="headerlink" title="2. redis服务"></a>2. redis服务</h2><p>(1) 拉取redis</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull redis:5.0.12</span><br></pre></td></tr></table></figure>

<p>(2) redis启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 6379:6379 --name redis01 --restart=always redis:5.0.12</span><br></pre></td></tr></table></figure>

<p>(3) 进入redis服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 进入docker中redis的工作目录</span><br><span class="line">docker <span class="built_in">exec</span> -it e1 bash</span><br><span class="line">// 进入redis服务</span><br><span class="line">redis-cli</span><br></pre></td></tr></table></figure>

<p>(4) redis内存数据持久化</p>
<ol>
<li>aof持久化; redis服务器将所有redis客户端的写操作以命令方式记录到日志文件中</li>
<li>rdb持久化: 快照redis服务器将某一时刻数据以快照文件形式写入到磁盘</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 6379:6379 --name redis01 -v /root/redisdata:/data --restart=always redis-server --appendonly <span class="built_in">yes</span> redis:5.0.12</span><br><span class="line"></span><br><span class="line">--appendonly <span class="built_in">yes</span>  // 开启持久化</span><br></pre></td></tr></table></figure>

<p>(5) 自定义配置文件启动redis</p>
<ol>
<li>下载对应版本找到配置文件 进行修改 使用完整配置文件启动</li>
<li>创建指定文件名称直接修改需要的属性即可</li>
<li>上传配置文件到宿主机指定目录:  我们指定&#x2F;root&#x2F;rediscnfig&#x2F;redis.conf</li>
<li>启动redis, 将配置文件映射到容器, 并且配置为持久化文件</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 6379:6379 --name redis01 --restart=always -v /root/rediscfig:/data redis-server /data/redis.conf <span class="built_in">yes</span> redis:5.0.12</span><br></pre></td></tr></table></figure>

<p>注意: 外部连接时, 需要将配置文件中的bind设为bind: 0.0.0.0<br>但是本次配置文件为完整文件, 在日常开发中, 我们并不需要完整的配置, 所以我们需要自己配置一个部分需要的配置文件</p>
<h2 id="3-nginx服务"><a href="#3-nginx服务" class="headerlink" title="3. nginx服务"></a>3. nginx服务</h2><p>(1) 拉取nginx</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull nginx:1.19.10</span><br></pre></td></tr></table></figure>

<p>(2) 启动nginx</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 80:80 -d --restart=always --name nginx01 nginx:1.19.10</span><br></pre></td></tr></table></figure>

<p>(3) 加载指定nginx配置启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 80:80 -d --restart=always --name nginx01 -v /root/nginxconfig/nginx.conf:/etc/nginx/nginx.conf nginx:1.19.10</span><br></pre></td></tr></table></figure>

<ol>
<li>实现反向代理 负载均衡</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// 拷贝文件</span><br><span class="line">docker <span class="built_in">cp</span> 容器<span class="built_in">id</span>:/etc/nginx/nginx.conf /root/nginxconf</span><br><span class="line">docker run -p 80:80 -d --restart=always --name nginx01 -v /root/nginxconfig/nginx.conf:/etc/nginx/nginx.conf nginx1.19.10</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>nginx服务器</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 8081:80 -d --restart=always --name nginx02 -v /root/html:/usr/share/nginx/html nginx1.19.10</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>nginx服务器和负载均衡使用</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 8081:80 -d --restart=always --name nginx02 -v /root/html:/usr/share/nginx/html -v /root/nginxconfig/nginx.conf:/etc/nginx/nginx.conf nginx1.19.10</span><br></pre></td></tr></table></figure>

<h1 id="五-Dockerfile使用"><a href="#五-Dockerfile使用" class="headerlink" title="五. Dockerfile使用"></a>五. Dockerfile使用</h1><p>Dockerfile是镜像描述文件, 通过Dockerfile文件构建一个属于自己的镜像</p>
<p>Dockerfile命令</p>
<table>
<thead>
<tr>
<th>保留字</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>FROM</td>
<td>当前镜像是基于哪个镜像的</td>
</tr>
<tr>
<td>MAINTAINER</td>
<td>镜像维护者的姓名和邮箱地址</td>
</tr>
<tr>
<td>RUN</td>
<td>构建镜像时需要运行的指令</td>
</tr>
<tr>
<td>EXPOSE</td>
<td>当前容器对外暴露出的端口号</td>
</tr>
<tr>
<td>WORKDIR</td>
<td>指定在创建容器后, 终端默认登录进来的工作目录, 一个落脚点</td>
</tr>
<tr>
<td>ENV</td>
<td>用来在构建镜像过程中设置环境变量</td>
</tr>
<tr>
<td>ADD</td>
<td>将宿主机目录下的文件拷贝进镜像且ADD命令会自动处理URL和解压tar包</td>
</tr>
<tr>
<td>COPY</td>
<td>类似于ADD, 拷贝文件和目录到镜像中, 将从构建上下文目录中原路径的文件&#x2F;目录复制到新的一层的镜像内的目标路径位置</td>
</tr>
<tr>
<td>VOLUME</td>
<td>容器数据卷, 用于数据保存和持久化工作</td>
</tr>
<tr>
<td>CMD</td>
<td>指定一个容器启动时要运行的命令, Dockerfile中可以有多个CMD指令, 但只有最后一个生效, CMD会被docker run之后的参数替换</td>
</tr>
<tr>
<td>ENTRYPOINT</td>
<td>指定一个容器启动时要运行的命令, ENTRYPOINT的目的和CMD一样, 都是在指定容器启动程序及其参数</td>
</tr>
</tbody></table>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2023/09/21/Spring Security + JWT/"><span>Spring Security + JWT简述</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2023/09/21/Spring Security + JWT/" rel="bookmark">
        <time class="entry-date published" datetime="2023-09-21T01:26:51.000Z">
          2023-09-21
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="一-什么是Spring-Security"><a href="#一-什么是Spring-Security" class="headerlink" title="一. 什么是Spring Security"></a>一. 什么是Spring Security</h1><blockquote>
<p>Spring Security是Spring家族的一个安全管理框架, 相比于另一个安全框架Shiro, 它具有更丰富的功能。一般中大型项目都是使用SpringSecurity做安全框架, 而Shiro上手比较简单</p>
</blockquote>
<p>spring security 的核心功能:</p>
<ul>
<li><p>认证(你是谁): 只有你的用户名或密码正确才能访问某些资源</p>
</li>
<li><p>授权(你能干嘛): 当前用户具有哪些功能, 将资源进行划分, 如在公司中分为普通资料和高级资料, 只有经理用户以上才能访文高级资料, 其他人只能拥有访问普通资料的权限。</p>
</li>
</ul>
<h2 id="1-登陆校验的流程"><a href="#1-登陆校验的流程" class="headerlink" title="1. 登陆校验的流程"></a>1. 登陆校验的流程</h2><p><img src="https://img-blog.csdnimg.cn/f78850412d8a4fa79bb9b275531086ad.png" alt="在这里插入图片描述"></p>
<h2 id="2-SpringSecurity基础案例"><a href="#2-SpringSecurity基础案例" class="headerlink" title="2. SpringSecurity基础案例"></a>2. SpringSecurity基础案例</h2><p>首先创建一个Springboot的项目</p>
<p>添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>创建一个controller类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动项目访问<code>http://localhost:8080/login</code>, 发现页面并没有hello字符, 下图是SpringSeurity默认的登陆界面, 默认用户名为user, 密码为启动项目时在输出框中的内容</p>
<p><img src="https://img-blog.csdnimg.cn/929a1f992b01446bacd88655832940c8.png" alt="在这里插入图片描述"></p>
<p><img src="https://img-blog.csdnimg.cn/bd359715ccf644f7b6289d24f2c56aa4.png" alt="在这里插入图片描述"><br>在实际项目中, 显然不能使用默认的登陆界面, 所以我们需要自定义登陆认证和授权</p>
<h1 id="二-Spring-Security原理流程"><a href="#二-Spring-Security原理流程" class="headerlink" title="二. Spring Security原理流程"></a>二. Spring Security原理流程</h1><p>SpringSecurity底层实现是一系列过滤器链</p>
<p>默认自动配置的过滤器<br><img src="https://img-blog.csdnimg.cn/e783a882bb0e4df181f6054288e34e8f.png" alt="在这里插入图片描述"></p>
<table>
<thead>
<tr>
<th>过滤器</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>WebAsyncManagerIntegrationFilter</td>
<td>将WebAsyncManger与SpringSecurity上下文进行集成</td>
</tr>
<tr>
<td>SecurityContextPersistenceFilter</td>
<td>在处理请求之前, 将安全信息加载到SecurityContextHolder中</td>
</tr>
<tr>
<td>HeaderWriterFilter</td>
<td>处理头信息假如响应中</td>
</tr>
<tr>
<td>CsrfFilter</td>
<td>处理CSRF攻击</td>
</tr>
<tr>
<td>LogoutFilter</td>
<td>处理注销登录</td>
</tr>
<tr>
<td>UsernamePasswordAuthenticationFilter</td>
<td>处理表单登录</td>
</tr>
<tr>
<td>DefaultLoginPageGeneratingFilter</td>
<td>配置默认登录页面</td>
</tr>
<tr>
<td>DefaultLogoutPageGeneratingFilter</td>
<td>配置默认注销页面</td>
</tr>
<tr>
<td>BasicAuthenticationFilter</td>
<td>处理HttpBasic登录</td>
</tr>
<tr>
<td>RequestCacheAwareFilter</td>
<td>处理请求缓存</td>
</tr>
<tr>
<td>SecurityContextHolderAwareRequestFilter</td>
<td>包装原始请求</td>
</tr>
<tr>
<td>AnonymousAuthenticationFilter</td>
<td>配置匿名认证</td>
</tr>
<tr>
<td>SessionManagementFilter</td>
<td>处理session并发问题</td>
</tr>
<tr>
<td>ExceptionTranslationFilter</td>
<td>处理认证&#x2F;授权中的异常</td>
</tr>
<tr>
<td>FilterSecurityInterceptor</td>
<td>处理授权相关</td>
</tr>
</tbody></table>
<p>下图是主要的过滤器<br><img src="https://img-blog.csdnimg.cn/55acb4e7ed454a9697c062f889594fa6.png" alt="在这里插入图片描述"></p>
<p>上图只画出了核心的过滤器</p>
<p><strong>UsernamePasswordAuthenticationFilter</strong>: 负责处理登陆页面填写的用户名和密码的登陆请求</p>
<p><strong>ExceptionTranslationFilter</strong>: 处理过滤器链中抛出的任何AccessDeniedException和AuthenticationException异常</p>
<p><strong>FilterSecurityInterceptor</strong>: 负责权限校验的过滤器</p>
<h2 id="1-大致流程"><a href="#1-大致流程" class="headerlink" title="1. 大致流程"></a>1. 大致流程</h2><p><img src="https://img-blog.csdnimg.cn/e7f09bb8bded468ca79e1fab09a24356.png" alt="在这里插入图片描述"><br><strong>(1)</strong>  下面是<code>UsernamePasswordAuthenticationFilter</code>中的<code>attemptAuthentication</code>方法,  该方法会将前端发送的用户名和密码封装为<code>UsernamePasswordAuthenticationToken</code>对象, 该对象是<code>Authentication</code>对象的实现类</p>
<p>注意: <code>attemptAuthentication</code>方法主要处理视图表单认证, 现今都是前后端分离项目导致不能使用该方法进行拦截, 所以我们需要自己实现一个过滤器覆盖或者在<code>UsernamePasswordAuthenticationFilter</code>之前做用户名和密码拦截处理.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Authentication <span class="title function_">attemptAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.postOnly &amp;&amp; !request.getMethod().equals(<span class="string">&quot;POST&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AuthenticationServiceException</span>(<span class="string">&quot;Authentication method not supported: &quot;</span> + request.getMethod());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> <span class="built_in">this</span>.obtainUsername(request);</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> <span class="built_in">this</span>.obtainPassword(request);</span><br><span class="line">        <span class="keyword">if</span> (username == <span class="literal">null</span>) &#123;</span><br><span class="line">            username = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (password == <span class="literal">null</span>) &#123;</span><br><span class="line">            password = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        username = username.trim();</span><br><span class="line">        <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(username, password);</span><br><span class="line">        <span class="built_in">this</span>.setDetails(request, authRequest);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.getAuthenticationManager().authenticate(authRequest);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>(2)</strong> 返回<code>getAuthenticationManager.authenticate(authRequest)</code>, 将未认证的<code>Authentication</code>对象传入<code>AuthenticationManager</code> , 进入<code>authenticate</code>方法我们看到<code>AuthenticationManager</code>是一个接口, 该接口主要做认证管理, 它的默认实现类是<code>ProviderManager</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AuthenticationManager</span> &#123;</span><br><span class="line">    Authentication <span class="title function_">authenticate</span><span class="params">(Authentication var1)</span> <span class="keyword">throws</span> AuthenticationException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>(3)</strong> 在SpringSecurity中, 在项目中支持多种不同方式的认证方式, 不同的认证方式对应不同的<code>AuthenticationProvider</code>,  多个<code>AuthenticationProvider</code> 组成一个列表, 这个列表由<code>ProviderManager</code>代理, 在<code>ProviderManager</code>中遍历列表中的每一个<code>AuthenticationProvider</code>进行认证</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Authentication <span class="title function_">authenticate</span><span class="params">(Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">    Class&lt;? <span class="keyword">extends</span> <span class="title class_">Authentication</span>&gt; toTest = authentication.getClass();</span><br><span class="line">    <span class="type">AuthenticationException</span> <span class="variable">lastException</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">AuthenticationException</span> <span class="variable">parentException</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">Authentication</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">Authentication</span> <span class="variable">parentResult</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">debug</span> <span class="operator">=</span> logger.isDebugEnabled();</span><br><span class="line">    <span class="comment">// 迭代遍历认证列表</span></span><br><span class="line">    <span class="type">Iterator</span> <span class="variable">var8</span> <span class="operator">=</span> <span class="built_in">this</span>.getProviders().iterator();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(var8.hasNext()) &#123;</span><br><span class="line">    	<span class="comment">// 取出当前认证</span></span><br><span class="line">        <span class="type">AuthenticationProvider</span> <span class="variable">provider</span> <span class="operator">=</span> (AuthenticationProvider)var8.next();</span><br><span class="line">        <span class="comment">// 当前认证是否支持当前的用户名和密码信息</span></span><br><span class="line">        <span class="keyword">if</span> (provider.supports(toTest)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (debug) &#123;</span><br><span class="line">                logger.debug(<span class="string">&quot;Authentication attempt using &quot;</span> + provider.getClass().getName());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">            	<span class="comment">// 开始做认证处理</span></span><br><span class="line">                result = provider.authenticate(authentication);</span><br><span class="line">                <span class="keyword">if</span> (result != <span class="literal">null</span>) &#123;</span><br><span class="line">                	<span class="comment">// 认证成功时候返回</span></span><br><span class="line">                    <span class="built_in">this</span>.copyDetails(authentication, result);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InternalAuthenticationServiceException | AccountStatusException var13) &#123;</span><br><span class="line">                <span class="built_in">this</span>.prepareException(var13, authentication);</span><br><span class="line">                <span class="keyword">throw</span> var13;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (AuthenticationException var14) &#123;</span><br><span class="line">                lastException = var14;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 不支持当前认证并且parent支持该认证</span></span><br><span class="line">    <span class="keyword">if</span> (result == <span class="literal">null</span> &amp;&amp; <span class="built_in">this</span>.parent != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            result = parentResult = <span class="built_in">this</span>.parent.authenticate(authentication);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ProviderNotFoundException var11) &#123;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (AuthenticationException var12) &#123;</span><br><span class="line">            parentException = var12;</span><br><span class="line">            lastException = var12;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.eraseCredentialsAfterAuthentication &amp;&amp; result <span class="keyword">instanceof</span> CredentialsContainer) &#123;</span><br><span class="line">            ((CredentialsContainer)result).eraseCredentials();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (parentResult == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.eventPublisher.publishAuthenticationSuccess(result);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (lastException == <span class="literal">null</span>) &#123;</span><br><span class="line">            lastException = <span class="keyword">new</span> <span class="title class_">ProviderNotFoundException</span>(<span class="built_in">this</span>.messages.getMessage(<span class="string">&quot;ProviderManager.providerNotFound&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;toTest.getName()&#125;, <span class="string">&quot;No AuthenticationProvider found for &#123;0&#125;&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (parentException == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.prepareException((AuthenticationException)lastException, authentication);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> lastException;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>拓展:<br><code>ProviderManager</code>可以配置一个<code>AuthenticationManager</code>作为parent, 当<code>ProviderManager</code>认证失败后, 可以进入parent中再次进行认证, 通常由<code>ProviderManager</code>来充当parent的角色, 即<code>ProviderManager</code>是<code>ProviderManager</code>的parent<br><code>ProviderManager</code>可以有多个, 而多个<code>ProviderManager</code>共用一个parent</p>
<p><img src="https://img-blog.csdnimg.cn/8426175c37764d13a723a7c9b2b43431.png" alt="在这里插入图片描述"></p>
<p><strong>(4)</strong> 当前<code>AuthenticationProvider</code>支持认证时, 会进入<code>AuthenticationProvider</code>的<code>authenticate</code>方法, 而<code>AuthenticationProvider</code>是一个接口, 它的实现类是<code>AbstractUserDetailsAuthenticationProvider</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Authentication <span class="title function_">authenticate</span><span class="params">(Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">    Assert.isInstanceOf(UsernamePasswordAuthenticationToken.class, authentication, () -&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.messages.getMessage(<span class="string">&quot;AbstractUserDetailsAuthenticationProvider.onlySupports&quot;</span>, <span class="string">&quot;Only UsernamePasswordAuthenticationToken is supported&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 获取当前authentication的信息</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> authentication.getPrincipal() == <span class="literal">null</span> ? <span class="string">&quot;NONE_PROVIDED&quot;</span> : authentication.getName();</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">cacheWasUsed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// 在缓存中查看username</span></span><br><span class="line">    <span class="type">UserDetails</span> <span class="variable">user</span> <span class="operator">=</span> <span class="built_in">this</span>.userCache.getUserFromCache(username);</span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">        cacheWasUsed = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        	<span class="comment">// 调用retrieveUser方法</span></span><br><span class="line">            user = <span class="built_in">this</span>.retrieveUser(username, (UsernamePasswordAuthenticationToken)authentication);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UsernameNotFoundException var6) &#123;</span><br><span class="line">            <span class="built_in">this</span>.logger.debug(<span class="string">&quot;User &#x27;&quot;</span> + username + <span class="string">&quot;&#x27; not found&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.hideUserNotFoundExceptions) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BadCredentialsException</span>(<span class="built_in">this</span>.messages.getMessage(<span class="string">&quot;AbstractUserDetailsAuthenticationProvider.badCredentials&quot;</span>, <span class="string">&quot;Bad credentials&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">throw</span> var6;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Assert.notNull(user, <span class="string">&quot;retrieveUser returned null - a violation of the interface contract&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.preAuthenticationChecks.check(user);</span><br><span class="line">        <span class="built_in">this</span>.additionalAuthenticationChecks(user, (UsernamePasswordAuthenticationToken)authentication);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (AuthenticationException var7) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!cacheWasUsed) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var7;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cacheWasUsed = <span class="literal">false</span>;</span><br><span class="line">        user = <span class="built_in">this</span>.retrieveUser(username, (UsernamePasswordAuthenticationToken)authentication);</span><br><span class="line">        <span class="built_in">this</span>.preAuthenticationChecks.check(user);</span><br><span class="line">        <span class="comment">// 密码的加密处理</span></span><br><span class="line">        <span class="built_in">this</span>.additionalAuthenticationChecks(user, (UsernamePasswordAuthenticationToken)authentication);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.postAuthenticationChecks.check(user);</span><br><span class="line">    <span class="keyword">if</span> (!cacheWasUsed) &#123;</span><br><span class="line">        <span class="built_in">this</span>.userCache.putUserInCache(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Object</span> <span class="variable">principalToReturn</span> <span class="operator">=</span> user;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.forcePrincipalAsString) &#123;</span><br><span class="line">        principalToReturn = user.getUsername();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.createSuccessAuthentication(principalToReturn, authentication, user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>(5)</strong> <code>retrieveUser</code>在<code>AbstractUserDetailsAuthenticationProvider</code>中有<code>retrieveUser</code>方法, 但是实现该方法的对象是<code>DaoAuthenticationProvider</code>, 该对象重写了<code>retrieveUser</code>方法, 在<code>retrieveUser</code>方法中, 可以看到调用了<code>UserDetailsService</code>的<code>loadUserByUsername()</code>方法, 该方法用来根据用户名查询内存或者其他数据源中的用户. 默认是基于内存查找, 我们可以自定义为数据库查询. 查询后的结果封装成<code>UserDetails</code> 对象, 该对象包含用户名、加密密码、权限以及账户相关信息. 密码的加密处理是SpringSecurity帮我们处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> UserDetails <span class="title function_">retrieveUser</span><span class="params">(String username, UsernamePasswordAuthenticationToken authentication)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">    <span class="built_in">this</span>.prepareTimingAttackProtection();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    	<span class="comment">// 调用该方法返回一个UserDetails 对象</span></span><br><span class="line">        <span class="type">UserDetails</span> <span class="variable">loadedUser</span> <span class="operator">=</span> <span class="built_in">this</span>.getUserDetailsService().loadUserByUsername(username);</span><br><span class="line">        <span class="keyword">if</span> (loadedUser == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InternalAuthenticationServiceException</span>(<span class="string">&quot;UserDetailsService returned null, which is an interface contract violation&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> loadedUser;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (UsernameNotFoundException var4) &#123;</span><br><span class="line">        <span class="built_in">this</span>.mitigateAgainstTimingAttack(authentication);</span><br><span class="line">        <span class="keyword">throw</span> var4;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InternalAuthenticationServiceException var5) &#123;</span><br><span class="line">        <span class="keyword">throw</span> var5;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var6) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InternalAuthenticationServiceException</span>(var6.getMessage(), var6);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="三-JWT"><a href="#三-JWT" class="headerlink" title="三. JWT"></a>三. JWT</h1><h2 id="1-什么是JWT"><a href="#1-什么是JWT" class="headerlink" title="1. 什么是JWT?"></a>1. 什么是JWT?</h2><p>JWT主要用于用户登陆鉴权, 在之前可能会使用session和token认证, 下面简述三者session和JWT的区别</p>
<p><strong>Session</strong></p>
<p>用户向服务器发送一个请求时, 服务器并不知道该请求是谁发的, 所以在用户发送登录请求时, 服务器会将用户提交的用户名和密码等信息保存在session会话中(一段内存空间)。同时服务器保存的用户信息会生成一个sessionid(相当于用户信息是一个value值, 而sessionid是value值的key)返回给客户端, 客户端将sessionid保存到cookie中, 等到下一次请求客户端会将cookie一同请求给服务器做认证</p>
<p>如果用户过多, 必然会耗费大量内存, 在cookie中存放sessionid会存在暴露用户信息的风险 </p>
<p><strong>Token</strong></p>
<p>token是一串随机的字符串也叫令牌, 其原理和session类似, 当用户登录时, 提交的用户名和密码等信息请求给服务端, 服务端会根据用户名或者其他信息生成一个token而不是sessionid, 这和sessionid唯一区别就是, token不再存储用户信息, 客户端下一次请求会携带token, 此时服务器根据此次token进行认证。</p>
<p>token认证时也会到数据库中查询, 会造成数据库压力过大。</p>
<p><strong>JWT</strong></p>
<p>JWT将登录时所有信息都存在自己身上, 并且以json格式存储, JWT不依赖Redis或者数据库, JWT安全性不太好, 所以不能存储敏感信息</p>
<h2 id="2-SpringSecurity集成JWT"><a href="#2-SpringSecurity集成JWT" class="headerlink" title="2. SpringSecurity集成JWT"></a>2. SpringSecurity集成JWT</h2><h3 id="1-认证配置"><a href="#1-认证配置" class="headerlink" title="(1) 认证配置"></a>(1) 认证配置</h3><p><strong>a) 配置SpringSecurity</strong></p>
<p>首先配置一个<code>SpringSecurity</code>的配置类, 因为是基于JWT进行认证, 所以需要在配置中禁用session机制, 并不是禁用整个系统的session功能</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserServiceImpl userDetailsService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LoginFilter loginFilter;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthFilter authFilter;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 禁用session机制 </span></span><br><span class="line">        http.csrf().disable()</span><br><span class="line">                .sessionManagement()</span><br><span class="line">                .sessionCreationPolicy(SessionCreationPolicy.STATELESS);</span><br><span class="line"></span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                <span class="comment">// 指定某些接口不需要通过验证即可访问。像登陆、注册接口肯定是不需要认证的</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/sec/login&quot;</span>).permitAll()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 自定义权限配置</span></span><br><span class="line">                .withObjectPostProcessor(<span class="keyword">new</span> <span class="title class_">ObjectPostProcessor</span>&lt;FilterSecurityInterceptor&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> &lt;O <span class="keyword">extends</span> <span class="title class_">FilterSecurityInterceptor</span>&gt; O <span class="title function_">postProcess</span><span class="params">(O o)</span> &#123;</span><br><span class="line">                        o.setAccessDecisionManager(customUrlDecisionManager);</span><br><span class="line">                        o.setSecurityMetadataSource(customFilter);</span><br><span class="line">                        <span class="keyword">return</span> o;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                .and()</span><br><span class="line">                <span class="comment">// 禁用缓存</span></span><br><span class="line">                .headers()</span><br><span class="line">                .cacheControl();</span><br><span class="line"></span><br><span class="line">        http.addFilterBefore(jwtAuthencationTokenFilter(), UsernamePasswordAuthenticationFilter.class);</span><br><span class="line">        <span class="comment">// 添加自定义未授权和未登陆结果返回</span></span><br><span class="line">        http.exceptionHandling()</span><br><span class="line">                .accessDeniedHandler(restfulAccessDeniedHandler)</span><br><span class="line">                .authenticationEntryPoint(restAuthoricationEntryPoint);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 指定UserDetailService和加密器</span></span><br><span class="line">        auth.userDetailsService(userDetailsService).passwordEncoder(passwordEncoder());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> AuthenticationManager <span class="title function_">authenticationManager</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.authenticationManager();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>     </span><br><span class="line">    <span class="keyword">public</span> PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>b) 实现登录接口</strong></p>
<p>先按照正常流程, 实现一个登录的接口然后在业务层中实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/login&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Res <span class="title function_">login</span><span class="params">(<span class="meta">@RequestBody</span> User user, HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> userService.login(user, request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在业务层中, 首先对密码和用户名进行检验, 然后更新security登录用户对象, 在此之前我们先来认识几个在<code>SpringSecurity</code>中重要的变量</p>
<p><code>Authentication</code>: 存储了认证信息, 代表登录用户<br><code>SecurityContext</code>: 上下文对象, 用来获取<code>Authentication</code>(用户信息)<br><code>SecurityContextHolder</code>: 上下文管理对象, 用来在程序任何地方获取<code>SecurityContext</code><br><code>UserDetails</code>: 存储了用户的基本信息, 以及用户权限、是否被禁用等</p>
<p>在<code>Authentication</code>中的认证信息有<br><code>Principal</code>: 用户信息<br><code>Credentials</code>: 用户凭证, 一般是密码<br><code>Authorities</code>: 用户权限</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Res <span class="title function_">login</span><span class="params">(User user, HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> user.getUsername();</span><br><span class="line">    <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> user.getPassword();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 登陆 检测</span></span><br><span class="line">    <span class="type">UserDetails</span> <span class="variable">userDetails</span> <span class="operator">=</span> userDetailsService.loadUserByUsername(username);</span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">null</span> == userDetails || !passwordEncoder.matches(password, userDetails.getPassword())) &#123;</span><br><span class="line">        <span class="keyword">return</span> Res.error(<span class="string">&quot;用户名或密码不正确!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 更新security登录用户对象</span></span><br><span class="line">    <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authenticationToken</span> <span class="operator">=</span> <span class="keyword">new</span></span><br><span class="line">            <span class="title class_">UsernamePasswordAuthenticationToken</span>(userDetails,</span><br><span class="line">            <span class="literal">null</span>, userDetails.getAuthorities());</span><br><span class="line">    SecurityContextHolder.getContext().setAuthentication(authenticationToken);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建一个token</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> jwtTokenUtil.generateToken(userDetails);</span><br><span class="line">    Map&lt;String, String&gt; tokenMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    tokenMap.put(<span class="string">&quot;token&quot;</span>, token);</span><br><span class="line">    tokenMap.put(<span class="string">&quot;tokenHead&quot;</span>, tokenHead);</span><br><span class="line">    <span class="keyword">return</span> Res.success(<span class="string">&quot;登陆成功&quot;</span>, tokenMap);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面这行代码主要是在数据库或者缓存中查询用户提交的用户名以及用户的权限信息, 将这些信息保存在<code>userDetails</code>中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">UserDetails</span> <span class="variable">userDetails</span> <span class="operator">=</span> userDetailsService.loadUserByUsername(username);</span><br></pre></td></tr></table></figure>
<p><code>UsernamePasswordAuthenticationToken</code> 实现了<code>Authentication</code>, 也就是说此时将userDetails中的信息以及权限信息存放在<code>Authentication</code>中</p>
<p>创建Token需要JWT的工具类, 在网上随便找个都可以, 大致都一样, 这个只需要知道就行了</p>
<p><strong>c) 过滤请求</strong></p>
<p>在原生<code>SpringSecurity</code>中默认的拦截在<code>UsernamePasswordAuthenticationFilter</code>这个类中,该类主要拦截表单提交的用户名和密码, 显然在前后端分离项目中不适用, 而且我们用到了JWT的验证方式, 前端每次请求都需要带上token, 所以我们需要在后端对每个请求进行提前过滤拦截</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtAuthencationTokenFilter</span> <span class="keyword">extends</span> <span class="title class_">OncePerRequestFilter</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jwt.tokenHeader&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String tokenHeader;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jwt.tokenHead&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String tokenHead;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtTokenUtil jwtTokenUtil;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span></span><br><span class="line">            <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="comment">// 请求头中获取token信息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">authheader</span> <span class="operator">=</span> request.getHeader(tokenHeader);</span><br><span class="line">        <span class="comment">// 存在token</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> != authheader &amp;&amp; authheader.startsWith(tokenHead)) &#123;</span><br><span class="line">            <span class="comment">// 去除字段名称, 获取真正token</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">authToken</span> <span class="operator">=</span> authheader.substring(tokenHead.length());</span><br><span class="line">            <span class="comment">// 利用token获取用户名</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> jwtTokenUtil.getUserNameFromToken(authToken);</span><br><span class="line">            <span class="comment">// token存在用户但未登陆</span></span><br><span class="line">            <span class="comment">// SecurityContextHolder.getContext().getAuthentication() 获取上下文对象中认证信息</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="literal">null</span> != username &amp;&amp; <span class="literal">null</span> == SecurityContextHolder.getContext().getAuthentication()) &#123;</span><br><span class="line">                <span class="comment">// 自定义数据源获取用户信息</span></span><br><span class="line">                <span class="type">UserDetails</span> <span class="variable">userDetails</span> <span class="operator">=</span> userDetailsService.loadUserByUsername(username);</span><br><span class="line">                <span class="comment">// 验证token是否有效 验证token用户名和存储的用户名是否一致以及是否在有效期内, 重新设置用户对象</span></span><br><span class="line">                <span class="keyword">if</span>(jwtTokenUtil.validateToken(authToken, userDetails)) &#123;</span><br><span class="line">                    <span class="comment">// 重新将用户信息封装到UsernamePasswordAuthenticationToken</span></span><br><span class="line">                    <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authenticationToken</span> <span class="operator">=</span> <span class="keyword">new</span></span><br><span class="line">                            <span class="title class_">UsernamePasswordAuthenticationToken</span>(userDetails, <span class="literal">null</span>, userDetails.getAuthorities());</span><br><span class="line">                    authenticationToken.setDetails(<span class="keyword">new</span> <span class="title class_">WebAuthenticationDetailsSource</span>().buildDetails(request));</span><br><span class="line">                    <span class="comment">// 将信息存入上下文对象</span></span><br><span class="line">                    SecurityContextHolder.getContext().setAuthentication(authenticationToken);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        filterChain.doFilter(request,response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该过滤器主要做的是: </p>
<ol>
<li>提取前端发送的请求头信息, 根据JWT的工具类获取用户名</li>
<li>如果请求头具有有效的字符串(也就是拥有用户信息)并且上下文对象存在用户信息(数据库或者缓存中查的用户信息)则直接到下一个过滤器, 否则请求头中有信息而当前上下文对象没有存储用户信息则将请求头中的用户在数据层验证之后重新放入上下文对象中(<code>UsernamePasswordAuthenticationToken</code>)。 </li>
<li>如果当前用户没有登录或者没有token信息(可能是token过期), 而当前请求的地址符合权限中包含的地址(也就是数据库中存在的), 则会进入权限验证(下面会讲)</li>
</ol>
<p>当然以上的逻辑可以自己自定义, 不管以上什么情况都会进入权限验证</p>
<p>要让这个过滤器加入到<code>SpringSecurity</code>的过滤器链中, 就需要在<code>SecurityConfig</code>类的<code>configure</code>方法添加下面一条语句, <code>addFilterBefore()</code>将<code>jwtAuthencationTokenFilter()</code>, 放在<code>UsernamePasswordAuthenticationFilter</code>之前</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http.addFilterBefore(jwtAuthencationTokenFilter(), UsernamePasswordAuthenticationFilter.class);</span><br></pre></td></tr></table></figure>

<h3 id="2-权限配置"><a href="#2-权限配置" class="headerlink" title="(2) 权限配置"></a>(2) 权限配置</h3><p>在一个项目中, 不同的用户需要具有不同的权限, 我们怎么对用户进行区分呢?</p>
<p><strong>a) RBAC权限表</strong></p>
<p>将用户、角色和权限绑定，这样可以知道某个用户具有哪些角色, 而某个角色对应有哪些权限（能干什么，不能干什么），这样就知道哪些用户拥有的角色和权限信息。</p>
<p>基于以上的想法, 我们需要三张实体表, 还需要两张多对多的关系表, 这样就构成了RBAC的五张表</p>
<p><strong>b) 授权流程</strong></p>
<p>在SpringSecurity中授权的过滤器是<code>FilterSecurityInterceptor</code></p>
<p>默认的流程</p>
<ul>
<li>调用<code>SecurityMetadataSource</code>获取当前请求的鉴权规则</li>
<li>接着调用<code>AccessDecisionManager</code> 来校验当前用户的是否拥有当前权限</li>
<li>如果有权限就放行, 否则抛出异常, 该异常则会被<code>AccessDeniedHandler</code>处理</li>
</ul>
<p><strong>c) 自定义<code>SecurityMetadataSource</code></strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomFilter</span> <span class="keyword">implements</span> <span class="title class_">FilterInvocationSecurityMetadataSource</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ResourceService resourceService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;ConfigAttribute&gt; <span class="title function_">getAttributes</span><span class="params">(Object o)</span> <span class="keyword">throws</span> IllegalArgumentException &#123;</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> ((FilterInvocation) o).getRequest();</span><br><span class="line"></span><br><span class="line">        List&lt;Resource&gt; menus = resourceService.getResource();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Resource menu : menus) &#123;</span><br><span class="line">            String[] split = menu.getPath().split(<span class="string">&quot;:&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">AntPathRequestMatcher</span> <span class="variable">ant</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AntPathRequestMatcher</span>(split[<span class="number">1</span>]);</span><br><span class="line">            <span class="comment">// 如果请求方法和请求路径都匹配上了，则代表找到了这个请求所需的权限资源</span></span><br><span class="line">            <span class="keyword">if</span> (request.getMethod().equals(split[<span class="number">0</span>]) &amp;&amp; ant.matches(request)) &#123;</span><br><span class="line">                <span class="comment">// 将我们权限资源id返回</span></span><br><span class="line">                <span class="keyword">return</span> Collections.singletonList(<span class="keyword">new</span> <span class="title class_">SecurityConfig</span>(menu.getId().toString()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;ConfigAttribute&gt; <span class="title function_">getAllConfigAttributes</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">supports</span><span class="params">(Class&lt;?&gt; aClass)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>FilterInvocationSecurityMetadataSource</code>继承<code>SecurityMetadataSource</code></p>
<p>在<code>getAttributes</code>方法中, o参数封装了<code>request</code>的相关信息, 可以从中获取请求的方法和URL等信息</p>
<p>然后menus得到的是当前数据层中所有的权限路径, 接着循环所有的路径信息与当前请求的方法和URL进行验证, 如果在数据层中没有当前请求则返回null, 否则将该权限的在数据层中的信息返回</p>
<p><strong>c) 自定义<code>AccessDecisionManager</code></strong> </p>
<p>如果在<code>SecurityMetadataSource</code>中有权限信息, 则会进入该方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomUrlDecisionManager</span> <span class="keyword">implements</span> <span class="title class_">AccessDecisionManager</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">decide</span><span class="params">(Authentication authentication, Object o, Collection&lt;ConfigAttribute&gt; collection)</span> <span class="keyword">throws</span> AccessDeniedException, InsufficientAuthenticationException &#123;</span><br><span class="line">        <span class="keyword">if</span>(Collections.isEmpty(collection)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (ConfigAttribute configAttribute : collection) &#123;</span><br><span class="line">            <span class="keyword">for</span> (GrantedAuthority authority : authentication.getAuthorities()) &#123;</span><br><span class="line">            	<span class="keyword">if</span>(<span class="string">&quot;ROLE_ANONYMOUS&quot;</span>.equals(authority.getAuthority())) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AccessDeniedException</span>(<span class="string">&quot;尚未登录, 请登录&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(Objects.equals(authority.getAuthority(), configAttribute.getAttribute())) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AccessDeniedException</span>(<span class="string">&quot;权限不足, 请联系管理员!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">supports</span><span class="params">(ConfigAttribute configAttribute)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">supports</span><span class="params">(Class&lt;?&gt; aClass)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先来看几个变量</p>
<ol>
<li>ConfigAttribute: 这个是鉴权的规则, 根据自己项目设定, 我们这里填入的是当前请求和数据层中相匹配的权限信息id</li>
<li>GrantedAuthority: 当前认证用户所拥有的权限信息</li>
</ol>
<p>在上述的<code>decide</code>方法中, 主要验证了用户所拥有的权限和当前请求的权限信息是否一致</p>
<p>如果不一致, 则抛出异常, 被<code>AccessDeniedHandler</code>处理</p>
<p><strong>d) 自定义<code>AccessDeniedHandler</code></strong> </p>
<p>自定义返回json格式数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RestfulAccessDeniedHandler</span> <span class="keyword">implements</span> <span class="title class_">AccessDeniedHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AccessDeniedException accessDeniedException)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        response.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json&quot;</span>);</span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">        <span class="type">Res</span> <span class="variable">bean</span> <span class="operator">=</span> Res.error(<span class="string">&quot;权限不足, 请联系管理员!&quot;</span>);</span><br><span class="line">        bean.setCode(<span class="number">403</span>);</span><br><span class="line">        out.write(<span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(bean));</span><br><span class="line">        out.flush();</span><br><span class="line">        out.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>e) 在<code>SpringSecurity</code>中的配置</strong></p>
<p>在configure方法中, 进行了动态权限配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.withObjectPostProcessor(<span class="keyword">new</span> <span class="title class_">ObjectPostProcessor</span>&lt;FilterSecurityInterceptor&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;O <span class="keyword">extends</span> <span class="title class_">FilterSecurityInterceptor</span>&gt; O <span class="title function_">postProcess</span><span class="params">(O o)</span> &#123;</span><br><span class="line">        o.setAccessDecisionManager(customUrlDecisionManager);</span><br><span class="line">        o.setSecurityMetadataSource(customFilter);</span><br><span class="line">        <span class="keyword">return</span> o;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>插入: 还有一个认证异常处理</p>
<ol>
<li>用户首次登录且验证成功, 此时正常用户权限授权</li>
<li>请求数据时, 非首次登录, 如果没有携带token(token过期), 又或者没有登录访问内部路径时, 说明没有认证权限不能访问, 抛出未登录异常</li>
<li>请求数据时, 有token信息, 而上下文对象中没有用户信息, 则会重新将用户信息放入上下文对象中, 接着进入权限验证, 如果用户拥有该权限则放行, 如果没有该权限则抛出权限不足异常</li>
</ol>
<p>在configure中配置未登录和未授权异常处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http.exceptionHandling()</span><br><span class="line">                .accessDeniedHandler(restfulAccessDeniedHandler)</span><br><span class="line">                .authenticationEntryPoint(restAuthoricationEntryPoint);</span><br></pre></td></tr></table></figure>

<h1 id="四-总结"><a href="#四-总结" class="headerlink" title="四. 总结"></a>四. 总结</h1><p>其实以上配置还有很多漏洞, 比如token的过期时间, 当用户上一秒还在请求数据, 下一秒token过期, 则会造成用户需要重新登录, 显然不合适</p>
<p>本人也是初学SpringSecurity, 以上这是个人的学习见解, 如有不足之处还望指出, 大佬勿喷!!!</p>
<p>这是项目的地址 <a  href ="https://github.com/SweiJ/Java_Daily/tree/master/secsys">Github下载</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2023/09/21/hello-world/"><span>Hello World</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2023/09/21/hello-world/" rel="bookmark">
        <time class="entry-date published" datetime="2023-09-21T00:43:05.242Z">
          2023-09-21
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    

    </div>

    
  </div>
</article>




<nav class="pagination">
  
  
</nav>
    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2023 Swei
    
  </p>
</footer>
    
    
  </div>
</div>
</body>
</html>